{% extends 'dashboards/base.html' %}
{% block title %}Quản lý môn học{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Danh sách môn học</h3>
    <a href="{% url 'dashboards:admin:courses:create' %}" class="btn btn-primary">+ Thêm môn học</a>
  </div>

  <form method="get" class="row g-2 mb-3">
    <div class="col-md-4">
      <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Tìm theo tên hoặc mã môn">
    </div>
    <div class="col-md-3">
      <select name="teacher" class="form-select">
        <option value="">— Tất cả giảng viên —</option>
        {% for t in teachers %}
        <option value="{{ t.id }}" {% if filter_teacher|default:'' == t.id|stringformat:'s' %}selected{% endif %}>
          {{ t.get_full_name|default:t.username }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select name="year" class="form-select">
        <option value="">— Tất cả năm học —</option>
        {% for y in years %}
        <option value="{{ y.id }}" {% if filter_year|default:'' == y.id|stringformat:'s' %}selected{% endif %}>{{ y.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-secondary w-100" type="submit">Lọc</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Mã</th>
          <th>Tên môn</th>
          <th>Giảng viên phụ trách</th>
          <th>Năm học</th>
          <th>SV đăng ký</th>
          <th>Trạng thái</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for c in courses %}
        <tr>
          <td>{{ c.code }}</td>
          <td>{{ c.name }}</td>
          <td>
            <div>{{ c.teacher.get_full_name|default:c.teacher.username }}</div>
            {% with assistants=c.assistant_teachers.all %}
              {% if assistants %}
              <div class="small text-muted">Phụ trách cùng: 
                {% for a in assistants %}
                  {{ a.get_full_name|default:a.username }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </div>
              {% endif %}
            {% endwith %}
          </td>
          <td>{{ c.academic_year.name|default:'Tự chọn' }}</td>
          <td>{{ c.students.count }}</td>
          <td>
            <span class="badge text-bg-secondary">{{ c.get_status_display }}</span>
          </td>
          <td class="text-end">
            <a href="{% url 'dashboards:admin:courses:edit' c.id %}" class="btn btn-sm btn-outline-primary">Sửa</a>
            <a href="{% url 'dashboards:admin:courses:delete' c.id %}" class="btn btn-sm btn-outline-danger">Xóa</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">Không có môn học nào.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
  <nav aria-label="Phân trang" class="mt-3">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if filter_teacher %}&teacher={{ filter_teacher }}{% endif %}{% if filter_year %}&year={{ filter_year }}{% endif %}">Trước</a></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if filter_teacher %}&teacher={{ filter_teacher }}{% endif %}{% if filter_year %}&year={{ filter_year }}{% endif %}">Tiếp</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %} 