{% extends "dashboards/base.html" %}
{% load static %}

{% block title %}Quản Lý Người Dùng{% endblock %}

{% block page_title %}Quản Lý Người Dùng{% endblock %}

{% block content %}
<!-- Filter and Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <form method="get" class="row align-items-end">
                    <div class="col-md-3 mb-2">
                        <label for="search" class="form-label">Tìm kiếm</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search_query }}" placeholder="Tên, email, mã sinh viên...">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="role" class="form-label">Vai trò</label>
                        <select class="form-select" id="role" name="role">
                            <option value="">Tất cả</option>
                            {% for value, label in role_choices %}
                            <option value="{{ value }}" {% if value == selected_role %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="status" class="form-label">Trạng thái</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Tất cả</option>
                            <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Hoạt động</option>
                            <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>Ngưng</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label for="department" class="form-label">Khoa</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">Tất cả</option>
                            {% for value, label in department_choices %}
                            <option value="{{ value }}" {% if value == selected_department %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search"></i> Tìm kiếm
                        </button>
                        <a href="{% url 'core:dashboards:admin:user_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                Danh Sách Người Dùng 
                <span class="badge bg-primary">{{ total_users }}</span>
            </h4>
            <div>
                <a href="{% url 'core:dashboards:admin:user_create' %}" class="btn btn-success">
                    <i class="bi bi-person-plus"></i> Thêm Người Dùng
                </a>
                <a href="{% url 'core:dashboards:admin:user_import' %}" class="btn btn-info">
                    <i class="bi bi-upload"></i> Import CSV
                </a>
                <a href="{% url 'core:dashboards:admin:user_export' %}" class="btn btn-warning">
                    <i class="bi bi-download"></i> Export
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                {% if users %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                    </div>
                                </th>
                                <th>Thông Tin</th>
                                <th>Vai Trò</th>
                                <th>Khoa</th>
                                <th>Trạng Thái</th>
                                <th>Ngày Tham Gia</th>
                                <th>Lần Cuối Đăng Nhập</th>
                                <th>Hành Động</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input user-checkbox" type="checkbox" 
                                               value="{{ user.id }}">
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            {{ user.first_name|first|default:user.username|first|upper }}
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ user.get_full_name|default:user.username }}</div>
                                            <small class="text-muted">{{ user.email }}</small>
                                            {% if user.profile.student_id %}
                                            <br><small class="text-info">{{ user.profile.student_id }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if user.profile %}
                                    <span class="badge {% if user.profile.role == 'admin' %}bg-danger{% elif user.profile.role == 'teacher' %}bg-success{% else %}bg-info{% endif %}">
                                        {{ user.profile.get_role_display }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">Chưa đặt</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.profile.department %}
                                    <span class="badge bg-light text-dark">{{ user.profile.get_department_display }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_active %}
                                    <span class="badge bg-success">Hoạt động</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Ngưng</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ user.date_joined|date:"d/m/Y" }}</small>
                                </td>
                                <td>
                                    {% if user.last_login %}
                                    <small>{{ user.last_login|timesince }} trước</small>
                                    {% else %}
                                    <small class="text-muted">Chưa bao giờ</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'core:dashboards:admin:user_detail' user.pk %}" 
                                           class="btn btn-sm btn-outline-info" title="Xem chi tiết">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{% url 'core:dashboards:admin:user_edit' user.pk %}" 
                                           class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-warning toggle-status-btn" 
                                                data-user-id="{{ user.pk }}" 
                                                data-current-status="{{ user.is_active|yesno:'true,false' }}"
                                                title="{% if user.is_active %}Vô hiệu hóa{% else %}Kích hoạt{% endif %}">
                                            {% if user.is_active %}
                                            <i class="bi bi-pause"></i>
                                            {% else %}
                                            <i class="bi bi-play"></i>
                                            {% endif %}
                                        </button>
                                        {% if user != request.user %}
                                        <a href="{% url 'core:dashboards:admin:user_delete' user.pk %}" 
                                           class="btn btn-sm btn-outline-danger" title="Xóa"
                                           onclick="return confirm('Bạn có chắc muốn xóa người dùng này?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Bulk Actions -->
                <div class="p-3 border-top bg-light">
                    <form method="post" action="{% url 'core:dashboards:admin:bulk_actions' %}" id="bulkActionForm">
                        {% csrf_token %}
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">Với các mục đã chọn:</span>
                                    <select name="bulk_action" class="form-select form-select-sm me-2" style="width: auto;">
                                        <option value="">Chọn hành động</option>
                                        <option value="activate">Kích hoạt</option>
                                        <option value="deactivate">Vô hiệu hóa</option>
                                        <option value="delete">Xóa</option>
                                    </select>
                                    <button type="submit" class="btn btn-sm btn-primary" disabled id="bulkActionBtn">
                                        Thực hiện
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <span id="selectedCount">0</span> mục đã chọn
                            </div>
                        </div>
                        <input type="hidden" name="user_ids" id="selectedUserIds">
                    </form>
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                <div class="p-3 border-top">
                    <nav aria-label="Phân trang">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}">{{ num }}</a>
                            </li>
                            {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_role %}&role={{ selected_role }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_department %}&department={{ selected_department }}{% endif %}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}

                {% else %}
                <div class="text-center py-5">
                    <div class="text-muted">
                        <i class="bi bi-people fs-1"></i>
                        <h4>Không có người dùng nào</h4>
                        <p>Chưa có người dùng nào trong hệ thống.</p>
                        <a href="{% url 'core:dashboards:admin:user_create' %}" class="btn btn-primary">
                            <i class="bi bi-person-plus"></i> Thêm Người Dùng Đầu Tiên
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Select All functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateBulkActions();
});

// Individual checkbox functionality
document.querySelectorAll('.user-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateBulkActions);
});

function updateBulkActions() {
    const checked = document.querySelectorAll('.user-checkbox:checked');
    const bulkActionBtn = document.getElementById('bulkActionBtn');
    const selectedCount = document.getElementById('selectedCount');
    const selectedUserIds = document.getElementById('selectedUserIds');
    
    selectedCount.textContent = checked.length;
    bulkActionBtn.disabled = checked.length === 0;
    
    // Update hidden input with selected IDs
    const ids = Array.from(checked).map(cb => cb.value);
    selectedUserIds.value = ids.join(',');
}

// Toggle Status functionality
document.querySelectorAll('.toggle-status-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const userId = this.dataset.userId;
        const currentStatus = this.dataset.currentStatus === 'true';
        
        if (confirm(`Bạn có chắc muốn ${currentStatus ? 'vô hiệu hóa' : 'kích hoạt'} người dùng này?`)) {
            fetch(`/dashboard/admin/users/${userId}/toggle-status/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to update the UI
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            })
            .catch(error => {
                alert('Có lỗi xảy ra khi thực hiện hành động');
            });
        }
    });
});

// Bulk Action Form Submission
document.getElementById('bulkActionForm').addEventListener('submit', function(e) {
    const action = this.querySelector('[name="bulk_action"]').value;
    const selectedCount = document.querySelectorAll('.user-checkbox:checked').length;
    
    if (!action) {
        e.preventDefault();
        alert('Vui lòng chọn hành động');
        return;
    }
    
    if (selectedCount === 0) {
        e.preventDefault();
        alert('Vui lòng chọn ít nhất một người dùng');
        return;
    }
    
    const actionText = {
        'activate': 'kích hoạt',
        'deactivate': 'vô hiệu hóa', 
        'delete': 'xóa'
    };
    
    if (!confirm(`Bạn có chắc muốn ${actionText[action]} ${selectedCount} người dùng đã chọn?`)) {
        e.preventDefault();
    }
});
</script>
{% endblock %} 