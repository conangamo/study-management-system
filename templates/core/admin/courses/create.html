{% extends 'admin/base.html' %}
{% block title %}{% if is_create %}Thêm môn học{% else %}Sửa môn học{% endif %} - Admin{% endblock %}
{% block page_title %}{% if is_create %}Thêm môn học{% else %}Sửa môn học{% endif %}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    /* Ensure Select2 container is visible */
    .select2-container {
        display: block !important;
        width: 100% !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple {
        min-height: 38px;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
        background-color: #0d6efd;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 2px 8px;
        margin: 2px;
        font-size: 0.9em;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        padding: 0;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__input {
        margin: 0;
        padding: 0;
        min-width: 200px;
    }
    
    .select2-results__option {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
    }
    
    .select2-results__option:last-child {
        border-bottom: none;
    }
    
    .teacher-option {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .teacher-checkbox {
        margin-right: 8px;
    }
    
    .teacher-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .teacher-name {
        font-weight: 500;
        color: #333;
    }
    
    .teacher-email {
        color: #666;
        font-size: 0.9em;
    }
    
    .teacher-department {
        color: #888;
        font-size: 0.8em;
        font-style: italic;
    }
    
    .select2-results__option--highlighted .teacher-name {
        color: white;
    }
    
    .select2-results__option--highlighted .teacher-email {
        color: #e0e0e0;
    }
    
    .select2-results__option--highlighted .teacher-department {
        color: #d0d0d0;
    }
    
    .select2-search__field {
        width: 100% !important;
        padding: 8px 12px !important;
        border: 1px solid #ddd !important;
        border-radius: 4px !important;
        font-size: 14px !important;
    }
    
    .select2-dropdown {
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 9999;
    }
    
    .select2-results__option[aria-selected="true"] {
        background-color: #e3f2fd;
    }
    
    .select2-results__option--highlighted[aria-selected="true"] {
        background-color: #2196f3;
    }
    
    /* Ensure the field is visible */
    #teacher-select {
        display: block !important;
        width: 100% !important;
        min-height: 38px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>{% if is_create %}Thêm môn học{% else %}Sửa môn học{% endif %}</h3>
        <a href="{% url 'core:admin_course_list' %}" class="btn btn-light">Quay lại</a>
    </div>

    <form method="post">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="row g-3">
            <!-- Basic Information -->
            <div class="col-md-6">
                <label class="form-label">{{ form.name.label }}{% if form.name.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.name }}
                {% if form.name.errors %}
                <div class="text-danger small">{{ form.name.errors }}</div>
                {% endif %}
            </div>

            <div class="col-md-6">
                <label class="form-label">{{ form.code.label }}{% if form.code.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.code }}
                {% if form.code.errors %}
                <div class="text-danger small">{{ form.code.errors }}</div>
                {% endif %}
            </div>

            <div class="col-md-6">
                <label class="form-label">{{ form.credits.label }}{% if form.credits.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.credits }}
                {% if form.credits.errors %}
                <div class="text-danger small">{{ form.credits.errors }}</div>
                {% endif %}
            </div>

            <div class="col-md-6">
                <label class="form-label">{{ form.semester.label }}{% if form.semester.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.semester }}
                {% if form.semester.errors %}
                <div class="text-danger small">{{ form.semester.errors }}</div>
                {% endif %}
            </div>

            <div class="col-12">
                <label class="form-label">{{ form.description.label }}{% if form.description.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.description }}
                {% if form.description.errors %}
                <div class="text-danger small">{{ form.description.errors }}</div>
                {% endif %}
            </div>

            <!-- Teachers Assignment -->
            <div class="col-12">
                <label class="form-label">{{ form.teachers.label }}{% if form.teachers.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.teachers }}
                {% if form.teachers.help_text %}
                <div class="form-text">{{ form.teachers.help_text }}</div>
                {% endif %}
                {% if form.teachers.errors %}
                <div class="text-danger small">{{ form.teachers.errors }}</div>
                {% endif %}
            </div>

            <!-- Academic Year -->
            <div class="col-md-6">
                <label class="form-label">{{ form.academic_year.label }}{% if form.academic_year.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.academic_year }}
                {% if form.academic_year.errors %}
                <div class="text-danger small">{{ form.academic_year.errors }}</div>
                {% endif %}
            </div>

            <div class="col-md-6">
                <label class="form-label">{{ form.max_students.label }}{% if form.max_students.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.max_students }}
                {% if form.max_students.errors %}
                <div class="text-danger small">{{ form.max_students.errors }}</div>
                {% endif %}
            </div>

            <!-- Dates -->
            <div class="col-md-6">
                <label class="form-label">{{ form.start_date.label }}{% if form.start_date.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.start_date }}
                {% if form.start_date.errors %}
                <div class="text-danger small">{{ form.start_date.errors }}</div>
                {% endif %}
            </div>

            <div class="col-md-6">
                <label class="form-label">{{ form.end_date.label }}{% if form.end_date.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.end_date }}
                {% if form.end_date.errors %}
                <div class="text-danger small">{{ form.end_date.errors }}</div>
                {% endif %}
            </div>

            <!-- Status -->
            <div class="col-md-6">
                <label class="form-label">{{ form.status.label }}{% if form.status.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.status }}
                {% if form.status.errors %}
                <div class="text-danger small">{{ form.status.errors }}</div>
                {% endif %}
            </div>

            <!-- Syllabus -->
            <div class="col-12">
                <label class="form-label">{{ form.syllabus.label }}{% if form.syllabus.field.required %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.syllabus }}
                {% if form.syllabus.errors %}
                <div class="text-danger small">{{ form.syllabus.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">
                {% if is_create %}Tạo môn học{% else %}Cập nhật{% endif %}
            </button>
            <a href="{% url 'core:admin_course_list' %}" class="btn btn-secondary">Hủy</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Select2 for teachers field with enhanced features
    $('#teacher-select').select2({
        theme: 'bootstrap-5',
        placeholder: 'Tìm và chọn giảng viên phụ trách...',
        allowClear: true,
        width: '100%',
        closeOnSelect: false,
        multiple: true,
        templateResult: formatTeacherOption,
        templateSelection: formatTeacherSelection,
        language: {
            noResults: function() {
                return "Không tìm thấy giảng viên";
            },
            searching: function() {
                return "Đang tìm kiếm...";
            },
            inputTooShort: function() {
                return "Vui lòng nhập ít nhất 1 ký tự để tìm kiếm";
            }
        }
    });
    
    // Custom template for dropdown options with checkbox
    function formatTeacherOption(teacher) {
        if (!teacher.id) return teacher.text;
        
        var $option = $(
            '<div class="teacher-option">' +
                '<input type="checkbox" class="teacher-checkbox" ' + 
                (teacher.selected ? 'checked' : '') + ' disabled>' +
                '<div class="teacher-info">' +
                    '<div class="teacher-name">' + teacher.text + '</div>' +
                '</div>' +
            '</div>'
        );
        
        return $option;
    }
    
    // Custom template for selected items
    function formatTeacherSelection(teacher) {
        if (!teacher.id) return teacher.text;
        
        // Extract name from the full text (remove email and department)
        var name = teacher.text.split(' (')[0];
        return name;
    }
    
    // Add search functionality
    $('#teacher-select').on('select2:open', function() {
        setTimeout(function() {
            $('.select2-search__field').attr('placeholder', 'Tìm kiếm theo tên hoặc email...');
        }, 10);
    });
});
</script>
{% endblock %} 