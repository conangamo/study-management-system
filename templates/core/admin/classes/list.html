{% extends 'admin/base.html' %}
{% block title %}Quản lý lớp học - Admin{% endblock %}
{% block page_title %}Quản lý lớp học{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="admin-card">
    <div class="admin-card-header d-flex justify-content-between align-items-center">
        <h5 class="admin-card-title mb-0">
            <i class="fas fa-users me-2"></i>Danh sách lớp học
        </h5>
        <div>
            <a href="{% url 'core:admin_class_create' %}" class="btn btn-admin btn-admin-primary me-2">
                <i class="fas fa-plus me-1"></i>Thêm lớp học
            </a>
            <a href="{% url 'core:admin_bulk_create_classes' %}" class="btn btn-admin btn-admin-success">
                <i class="fas fa-layer-group me-1"></i>Tạo hàng loạt
            </a>
        </div>
    </div>
    
    <div class="admin-card-body">
        <!-- Search and Filter Form -->
        <form method="get" class="mb-4">
            <div class="row g-3">
                <div class="col-md-3">
                    {{ form.search_query }}
                </div>
                <div class="col-md-2">
                    {{ form.academic_year_filter }}
                </div>
                <div class="col-md-2">
                    {{ form.department_filter }}
                </div>
                <div class="col-md-2">
                    {{ form.status_filter }}
                </div>
                <div class="col-md-2">
                    {{ form.advisor_filter }}
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-admin btn-admin-primary w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Classes Table -->
        <div class="table-responsive">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Tên lớp</th>
                        <th>Khoa/Ngành</th>
                        <th>Năm học</th>
                        <th>Sĩ số</th>
                        <th>Cố vấn</th>
                        <th>GV Chủ nhiệm</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for class in classes %}
                    <tr>
                        <td>
                            <div>
                                <strong>{{ class.name }}</strong>
                                <br>
                                <small class="text-muted">{{ class.display_name }}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ class.get_department_display }}</span>
                        </td>
                        <td>
                            <span class="badge bg-secondary">K{{ class.academic_year }}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2">{{ class.current_students }}/{{ class.max_students }}</span>
                                <div class="progress flex-grow-1" style="height: 6px;">
                                    {% widthratio class.current_students class.max_students 100 as percentage %}
                                    <div class="progress-bar {% if percentage > 90 %}bg-danger{% elif percentage > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                                         style="width: {{ percentage }}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if class.advisor %}
                            <div>
                                <strong>{{ class.advisor.get_full_name }}</strong>
                                {% if class.advisor.profile.department %}
                                <br><small class="text-muted">{{ class.advisor.profile.department }}</small>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted">Chưa phân công</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if class.head_teacher %}
                            <div>
                                <strong>{{ class.head_teacher.get_full_name }}</strong>
                                {% if class.head_teacher.profile.department %}
                                <br><small class="text-muted">{{ class.head_teacher.profile.department }}</small>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted">Chưa phân công</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if class.status == 'active' %}
                            <span class="badge bg-success">{{ class.get_status_display }}</span>
                            {% elif class.status == 'inactive' %}
                            <span class="badge bg-warning">{{ class.get_status_display }}</span>
                            {% elif class.status == 'graduated' %}
                            <span class="badge bg-info">{{ class.get_status_display }}</span>
                            {% else %}
                            <span class="badge bg-danger">{{ class.get_status_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{% url 'core:admin_class_detail' class.pk %}" 
                                   class="btn btn-sm btn-outline-primary" 
                                   title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'core:admin_class_edit' class.pk %}" 
                                   class="btn btn-sm btn-outline-warning" 
                                   title="Chỉnh sửa">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'core:admin_class_delete' class.pk %}" 
                                   class="btn btn-sm btn-outline-danger" 
                                   title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-users fa-3x mb-3"></i>
                                <p>Chưa có lớp học nào được tạo.</p>
                                <a href="{% url 'core:admin_class_create' %}" class="btn btn-admin btn-admin-primary">
                                    <i class="fas fa-plus me-1"></i>Tạo lớp học đầu tiên
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Class pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid mt-4">
    <div class="stat-card">
        <div class="stat-number">{{ classes.count }}</div>
        <div class="stat-label">Tổng số lớp</div>
        <i class="fas fa-users stat-icon"></i>
    </div>
    
    <div class="stat-card success">
        <div class="stat-number">{{ classes.count }}</div>
        <div class="stat-label">Lớp đang hoạt động</div>
        <i class="fas fa-check-circle stat-icon"></i>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-number">0</div>
        <div class="stat-label">Tổng sinh viên</div>
        <i class="fas fa-user-graduate stat-icon"></i>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">0.0</div>
        <div class="stat-label">TB sinh viên/lớp</div>
        <i class="fas fa-chart-bar stat-icon"></i>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 for teacher filter dropdowns
    $('.select2-search').select2({
        theme: 'bootstrap-5',
        width: '100%',
        allowClear: true,
        placeholder: function() {
            return $(this).data('placeholder');
        },
        minimumInputLength: 1,
        ajax: {
            url: '/custom-admin/users/search/',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return {
                    q: params.term,
                    role: 'teacher',
                    page: params.page || 1
                };
            },
            processResults: function(data, params) {
                params.page = params.page || 1;
                
                return {
                    results: data.results.map(function(item) {
                        return {
                            id: item.id,
                            text: item.text
                        };
                    }),
                    pagination: {
                        more: data.pagination && data.pagination.more
                    }
                };
            },
            cache: true
        }
    });
    
    // Auto-submit form when filters change
    $('.form-select').on('change', function() {
        $('#search-form').submit();
    });
    
    // Clear search button
    $('.btn-clear').on('click', function(e) {
        e.preventDefault();
        $('#id_search_query').val('');
        $('#id_academic_year_filter').val('').trigger('change');
        $('#id_department_filter').val('').trigger('change');
        $('#id_status_filter').val('').trigger('change');
        $('#id_advisor_filter').val('').trigger('change');
        $('#id_head_teacher_filter').val('').trigger('change');
        $('#search-form').submit();
    });
});
</script>
{% endblock %} 